# Reconstructing Individual Patient Data  {#math-sci}

<!-- Required to number equations in HTML files -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

There has been an increasing need for researchers within academia and/or the pharmaceutical industry to gain access to individual clinical trial patient data (IPD) so that they can perform various secondary analyses. However, due to the often-large sums that drug companies invest into research and development, these firms are understandably reluctant to grant free access to their data until they have fully made use of this resource. Therefore, there is the need to try to recreate IPD from published clinical trial reports through various methods. 
<br>

As a postgraduate student on an industrial placement this project had originally sought to make use of study data applied for under the placement companyâ€™s data sharing scheme in order to investigate different methods for handling non-proportional hazards. However, this request was rejected on the grounds that the data was still business sensitive. 
<br>

Through various industrial and academic sources, researchers are often able to access published Kaplan Meier (KM) curves and their corresponding summary statistics (CI and p-values), the numbers at risk in the study and potentially the total number of events witnessed in the clinical trial. 
<br>

From the published KM curves and the patient at risk data Wan et al. 2015 identified four methods that are capable of re-creating Individual Patient Data (IPD). 
<br>

The four methods are:

i. **The Least Squares approach**

This method can estimate the parameters via the minimisation of the sum of the squared residuals, where the residuals are the difference between the actual and estimated data. 

For example if 30 points of data $\left(\mathrm{x}_{1}, \mathrm{y}_{1}\right),\left(\mathrm{x}_{2}, \mathrm{y}_{2}\right), \ldots,\left(\mathrm{x}_{30}, \mathrm{y}_{30}\right)$ have been extracted from a KM curve, and are following a distribution that has a function in the form $\mathrm{y}=\mathrm{f}(\mathrm{x}, \beta)$ where $\beta=(\beta 1, \beta 2)$. The parameter $\beta$ vectors could be estimated via the method of Least Squares, in which the sum of the squared residuals has been minimised.

<br>

ii. **Graphical Approach**

A parametric model can be estimated via the graphical method. This approach requires the researcher to make a transformation of the survival function to a function with a linear form. A linear line is then fitted to the collection of points that have been extracted from the published KM curve. 

For example, the survival function of the Weibull distribution is: $$\log (S(t))=-\lambda t_{\gamma}$$ Where $\gamma$ is the shape and $\lambda$ is the scale parameter respectively. 

A transformation of this distribution can be made by taking the logarithm of the preceding equation: $$\log (S(t))=-\lambda t_{\gamma}$$ 

Taking the logarithm for the second time gives: $$\log (-\log (S(t)))=\log (\lambda)+ \gamma *\log (t)$$
From this formula it is possible to plot $$\log (-\log (S(t)))\ versus\ \log (t)$$ and henceforth make an estimate of the parameters. 

<br>

iii. **Interval-censored data estimation approach**

Hoyle and Henley put forward an approach to estimate IPD using the total number of patients, the respective numbers at risk, and the corresponding survival probabilities. However, this approach makes the assumption that there is constant censoring in each of the time intervals. 

<br>

iv. **Precise survival data approach**

The method of Guyot et al will be used to recreate the IPD from studies where different non-proportional hazards have been present. (Examples of the different types include, crossing hazards, a delayed treatment effect or diminishing treatment effect). 


## Mok et al. 2009 IPASS Study: Crossing Hazards

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Overall Study Results"}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

km_trt_fit <- survfit(Surv(time, event) ~ arm, data = IPD.Mok.A)

ggsurv <- ggsurvplot(
  km_trt_fit,                     # survfit object with calculated statistics.
  data = IPD.Mok.A,             # data used to fit survival curves.
  risk.table = TRUE,       # show risk table.
  pval = FALSE,             # show p-value of log-rank test.
  conf.int = FALSE,         # show confidence intervals for 
  # point estimates of survival curves.
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0,20),         # present narrower X axis, but not affect
  # survival estimates.
  xlab = "Months since Randomization",   # customize X axis label.
  ylab = "Pr of Progression-free Survival",   # customize X axis label.
  break.time.by = 4,     # break X axis in time intervals by 500.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.height = 0.25, # the height of the risk table
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  ncensor.plot.height = 0.25,
  conf.int.style = "step",  # customize style of confidence intervals
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = c("Carboplatin", "Gefitinib")    # change legend labels.
)

# Labels for Survival Curves (plot)
ggsurv$plot <- ggsurv$plot + labs(
  title    = "Kaplan-Meier Curves for Progression-free Survival",                  
  subtitle = "Overall Study Results"
)

# Changing the font size, style and color

ggsurv <- ggpar(
  ggsurv,
  font.title    = c(16, "bold", "black"),         
  font.subtitle = c(10, "bold.italic", "black"), 
  font.caption  = c(14, "plain", "black"),        
  font.x        = c(14, "bold.italic", "black"),          
  font.y        = c(14, "bold.italic", "black"),      
  font.xtickslab = c(12, "plain", "black"),
  legend = "top"
)

ggsurv
```

```{r, echo=FALSE, fig.cap="Summary Statistics", warning=FALSE, message=FALSE, eval=FALSE}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

IPD.Mok.A <- IPD.Mok.A[, 2:3]

# rename columns 
colnames(IPD.Mok.A) <- c("event", "Gefitinib")

IPD.Mok.A$Gefitinib <- ifelse(IPD.Mok.A$Gefitinib == 0, "Carboplatin-Paclitaxel", "Gefitinib")

IPD.Mok.A %>%
  tbl_summary(
    by = Gefitinib,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  modify_header(stat_by = md("**{level}**<br>N =  {n} ({style_percent(p)}%)")) %>%
  bold_labels() %>%
  modify_spanning_header(starts_with("stat_") ~ "**Summary Statistics**") %>% 
  add_p(test = all_continuous() ~ "t.test") %>%
  add_overall()
```

<br>
<br>

```{r, echo=FALSE, fig.cap= "Schoenfeld Test"}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

colnames(IPD.Mok.A) <- c("time", "event", "Gefitinib")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ Gefitinib, data = IPD.Mok.A) 

# Schoenfeld plot
par(mfrow=c(1,1))
plot(cox.zph(cox.model), main = "Schoenfeld Individual Test p: 0.00")
abline(h=0, col=2)
```

<br>
<br>

```{r echo=FALSE, fig.cap="Cox Proportional Hazards Model"}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

colnames(IPD.Mok.A) <- c("time", "event", "arm")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ arm, data = IPD.Mok.A) 

# format results into data frame with global p-values
cox.model %>%
  tbl_regression(
    show_single_row = arm,
    label = arm ~ "Gefitinib vs Carboplatin-Paclitaxel",
    exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

----------------------------------------------------------------------------------
  Average HR                           95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  0.965                              0.844, 1.104                   0.605   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher) Weighted Cox Proportional Hazards Model

At a given instant in time a patient recieving the Gefitinib treatment is 0.965 times as likely to die as a patient who is on the Carboplatin-Paclitaxel treatment. The 95% confidence interval was (0.844, 1.104) with p value 0.605.

<br>
<br>

----------------------------------------------------------------------------------
  $\hat{c}^{\prime} \%$                95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  49.12%                             0.458, 0.525                   0.605   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher1) Weighted Cox Proportional Hazards Model (Generalized Concordance)

With a probability of 49.12% (95% CI:45.8%, 52.5%), a patient treated with Gefitinib expected (at the baseline value) to die earlier than a patient treated with Carboplatin-Paclitaxel with p value 0.605.

<br>
<br>

```{r, echo=FALSE, fig.cap="Weights used by weighted Cox regression are plotted against time"}
knitr::include_graphics(path = "figure/mok.a.coxphw.svg")
```
In this study the increase in the censoring weights are small during the first six months of treatment, after this they begin to rise rapidly. However, it should be noted that the normalised total weight range is [0,25, 2]. 

```{r, include=FALSE}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

# Pooled Survival Function S(t-) or 1-S(t-) = S(t)
S <- survfit(Surv(time, event) ~ 1, data = IPD.Mok.A)
```

<br>
<br>

```{r, echo=FALSE}
# FH(1,0)  1-S(t-) vs t (Prentice-Wilcoxon)
plot(x = S$time, y = S$surv,
     main = "FH(1,0)  1-S(t-) vs Time (Prentice-Wilcoxon)", 
     xlab = "Time",
     ylab = "1-S(t-)",
     col = "blue")
```

<br>
<br>

```{r, echo=FALSE}
# FH(0,1) S(t) against t
plot(x = S$time, y = (1-S$surv),
     main = "FH(0,1) S(t) vs Time", 
     xlab = "Time",
     ylab = "S(t)",
     col = "blue")
```

<br>
<br>

```{r, echo=FALSE}
# Log.Rank 
plot(x = S$time, 
     y = rep(1, times = length(S$time)),
     main = "FH(0,0) Constant Function One Vs Time", 
     xlab = "Time",
     ylab = "Constant Function 1",
     col = "blue")
```

<br>
<br>

```{r, echo=FALSE}
# FH(1,1) S(t)*(1-S(t))
plot(x = S$time, 
     y = (S$surv)*(1-(S$surv)), 
     main = "FH(1,1) S(t)*(1-S(t))", 
     xlab = "Time",
     ylab = "S(t)*(1-S(t)",
     col = "blue")
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Weighted Log Rank Test"}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

colnames(IPD.Mok.A) <- c("time", "event", "arm")

IPD.Mok.A$event <- ifelse(IPD.Mok.A$event == 0, 1, 0)

result <- wlr.Stat(surv=IPD.Mok.A$time, cnsr=IPD.Mok.A$event, trt= IPD.Mok.A$arm, fparam=list(rho=c(0,0,1,1), gamma=c(0,1,1,0), wlr='FH(0,1)', APPLE=NULL))

result %>% 
  kableExtra::kable(caption = "Weighted Log Rank Test")
```

<br>
<br>

```{r, echo=FALSE, include=FALSE}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

rgs <- list(c(0, 0), c(0, 1), c(1, 1), c(1, 0))

draws <- 10

IPD.Mok.A$arm <- ifelse(IPD.Mok.A$arm == 0, "control", "experimental")

IPD.Mok.A$event <- ifelse(IPD.Mok.A$event == 0, 1, 0)

result.mc <- nphsim::combo.wlr(survival = IPD.Mok.A$time, cnsr = IPD.Mok.A$event, trt = IPD.Mok.A$arm, fparam = list(rgs=rgs,draws=draws))

result.mc <- lapply(result.mc, function(x) round(x, digits = 3))
```

```{r, echo=FALSE}
as.data.frame(result.mc) %>% kableExtra::kable(caption = "Max Combo Test")
```

<br>
<br>

```{r, include=FALSE, message=FALSE}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

IPD.Mok.A$arm <- ifelse(IPD.Mok.A$arm == 0, "control", "experimental")

IPD.Mok.A$event <- ifelse(IPD.Mok.A$event == 0, 1, 0)

result.rmst <- rmst.Stat(survival = IPD.Mok.A$time, cnsr = IPD.Mok.A$event, trt = IPD.Mok.A$arm, stra = NULL, fparam = 20)

result.rmst_ <- lapply(result.rmst, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.rmst_) %>% kableExtra::kable(caption = "Restricted Mean Survival Time")
```

```{r, include=FALSE}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

result.rmst2 = rmst2(time = IPD.Mok.A$time, status = IPD.Mok.A$event, arm = IPD.Mok.A$arm, tau = 20)

result.rmst2
```

The point estimate indicated that patients on the Gefitinib treatment survive `r round(result.rmst2$unadjusted.result[1,1],1)` months longer than those on Carboplatin-Paclitaxel group on average, when following up the patients `r result.rmst2$tau` months. The 95% confidence interval was (`r round(result.rmst2$unadjusted.result[1,2],1)` to `r round(result.rmst2$unadjusted.result[1,3],1)`) with p value `r round(result.rmst2$unadjusted.result[1,4],2)`.

```{r, echo=FALSE}
source("Libraries.R")

IPD.Mok.A <- readRDS("data/IPD.Mok.A.RDS")

result.rmst2 = rmst2(time = IPD.Mok.A$time, status = IPD.Mok.A$event, arm = IPD.Mok.A$arm, tau = 20)

plot(
result.rmst2,
xlab = "Months",
ylab = "Probability",
col = "black",
col.RMST = "#E7B800", 
col.RMTL = "#2E9FDF",
density = 80,
angle = 85
)

```

<br>
<br>

\clearpage 

## Brehmer et al. 2016 Nivolumab versus Docetaxel Study: Crossing Hazards

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Kaplanâ€“Meier curves for overall survival"}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

km_trt_fit <- survfit(Surv(time, event) ~ arm, data = IPD.Brahmer.a)

ggsurv <- ggsurvplot(
  km_trt_fit,                     # survfit object with calculated statistics.
  data = IPD.Brahmer.a,             # data used to fit survival curves.
  risk.table = TRUE,       # show risk table.
  pval = FALSE,             # show p-value of log-rank test.
  conf.int = FALSE,         # show confidence intervals for 
  # point estimates of survival curves.
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0,25),         # present narrower X axis, but not affect
  # survival estimates.
  xlab = "Months",   # customize X axis label.
  ylab = "Overall Survival (% of patients)",   # customize X axis label.
  break.time.by = 3,     # break X axis in time intervals by 500.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.height = 0.25, # the height of the risk table
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  ncensor.plot.height = 0.25,
  conf.int.style = "step",  # customize style of confidence intervals
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = c("Docetaxel","Nivolumab")    # change legend labels.
)

# Labels for Survival Curves (plot)
ggsurv$plot <- ggsurv$plot + labs(
  title    = "Kaplan-Meier Curves for overall survival"                
  # subtitle = "Overall Survival (% of patients)"
)

# Changing the font size, style and color

ggsurv <- ggpar(
  ggsurv,
  font.title    = c(16, "bold", "black"),         
  font.subtitle = c(10, "bold.italic", "black"), 
  font.caption  = c(14, "plain", "black"),        
  font.x        = c(14, "bold.italic", "black"),          
  font.y        = c(14, "bold.italic", "black"),      
  font.xtickslab = c(12, "plain", "black"),
  legend = "top"
)

ggsurv
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Summary Statistics", warning=FALSE, message=FALSE, eval=FALSE}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

IPD.Brahmer.a <- IPD.Brahmer.a[, 2:3]

# rename columns 
colnames(IPD.Brahmer.a) <- c("event", "Nivolumab")

IPD.Brahmer.a$Nivolumab <- ifelse(IPD.Brahmer.a$Nivolumab == 0, "Docetaxel", "Nivolumab")

IPD.Brahmer.a %>%
  tbl_summary(
    by = Nivolumab,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  modify_header(stat_by = md("**{level}**<br>N =  {n} ({style_percent(p)}%)")) %>%
  bold_labels() %>%
  modify_spanning_header(starts_with("stat_") ~ "**Summary Statistics**") %>% 
  add_p(test = all_continuous() ~ "t.test") %>%
  add_overall()
```

<br>
<br>

```{r, echo=FALSE}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

colnames(IPD.Brahmer.a) <- c("time", "event", "Nivolumab")

cox.model <- coxph(Surv(time, event) ~ Nivolumab, data = IPD.Brahmer.a) 

# Schoenfeld plot
par(mfrow=c(1,1))
plot(cox.zph(cox.model), main = "Schoenfeld Individual Test p: 0.002")
abline(h=0, col=2)
```

<br>
<br>

```{r echo=FALSE, fig.cap="Cox Proportional Hazards Model"}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

colnames(IPD.Brahmer.a) <- c("time", "event", "arm")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ arm, data = IPD.Brahmer.a) 

# format results into data frame with global p-values
cox.model %>%
  tbl_regression(
    show_single_row = arm,
    label = arm ~ "Nivolumab vs Docetaxel",
    exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

----------------------------------------------------------------------------------
  Average HR                           95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  0.846                              0.691, 1.0348                  0.104   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher) Weighted Cox Proportional Hazards Model

At a given instant in time a patient recieving the Nivolumab treatment is 0.846 times as likely to die as a patient who is on the Docetaxel treatment. The 95% confidence interval was (0.691, 1.0348) with p value 0.104.

<br>
<br>

----------------------------------------------------------------------------------
  $\hat{c}^{\prime} \%$                95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  45.82%                             40.87, 50.85                   0.104   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher1) Weighted Cox Proportional Hazards Model (Generalized Concordance)

With a probability of 45.82% (95% CI:45.8%, 52.5%), a patient treated with Nivolumab expected (at the baseline value) to die earlier than a patient treated with Docetaxel with p value 0.104.

<br>
<br>

```{r, echo=FALSE, fig.cap="Weights used by weighted Cox regression are plotted against time"}
knitr::include_graphics(path = "figure/brehmer.coxphw.svg")
```
In this study the increase in the censoring weights are small during the first nine months of treatment, after this they begin to rise rapidly. However, it should be noted that the normalised total weight range is [1, 2]. 

<br>
<br>

```{r, echo=FALSE, fig.cap="Weighted Log Rank Test"}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

IPD.Brahmer.a$event <- ifelse(IPD.Brahmer.a$event == 0, 1, 0)

colnames(IPD.Brahmer.a) <- c("time", "event", "arm")

result <- wlr.Stat(surv=IPD.Brahmer.a$time, cnsr=IPD.Brahmer.a$event, trt= IPD.Brahmer.a$arm, fparam=list(rho=c(0,0,1,1), gamma=c(0,1,1,0), wlr='FH(0,1)', APPLE=NULL))

result %>% 
  kableExtra::kable()
```

<br>
<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

IPD.Brahmer.a$event <- ifelse(IPD.Brahmer.a$event == 0, 1, 0)

IPD.Brahmer.a$arm <- ifelse(IPD.Brahmer.a$arm == 0, "control", "experimental")

rgs <- list(c(0, 0), c(0, 1), c(1, 1), c(1, 0))

draws <- 10

result.mc <- nphsim::combo.wlr(survival = IPD.Brahmer.a$time, cnsr = IPD.Brahmer.a$event, trt = IPD.Brahmer.a$arm, fparam = list(rgs=rgs,draws=draws))

result.mc <- lapply(result.mc, function(x) round(x, digits = 3))
```

```{r, echo=FALSE}
as.data.frame(result.mc) %>% kableExtra::kable()
```

<br>
<br>

```{r, include=FALSE, message=FALSE}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

IPD.Brahmer.a$arm <- ifelse(IPD.Brahmer.a$arm == 0, "control", "experimental")

IPD.Brahmer.a$event <- ifelse(IPD.Brahmer.a$event == 0, 1, 0)

result.rmst <- rmst.Stat(survival = IPD.Brahmer.a$time, cnsr = IPD.Brahmer.a$event, trt = IPD.Brahmer.a$arm, stra = NULL, fparam = 25)

result.rmst_ <- lapply(result.rmst, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.rmst_) %>% kableExtra::kable()
```

```{r, include=FALSE}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

result.rmst2 = rmst2(time = IPD.Brahmer.a$time, status = IPD.Brahmer.a$event, arm = IPD.Brahmer.a$arm, tau = 25)

result.rmst2
```

The point estimate indicated that patients on the Nivolumab treatment survive `r round(result.rmst2$unadjusted.result[1,1],1)` months longer than those on Docetaxel group on average, when following up the patients `r round(result.rmst2$tau, 0)` months. The 95% confidence interval was (`r round(result.rmst2$unadjusted.result[1,2],1)` to `r round(result.rmst2$unadjusted.result[1,3],1)`) with p value `r round(result.rmst2$unadjusted.result[1,4],2)`.

```{r, echo=FALSE}
source("Libraries.R")

IPD.Brahmer.a <- readRDS("data/IPD.Brahmer.a.RDS")

result.rmst2 = rmst2(time = IPD.Brahmer.a$time, status = IPD.Brahmer.a$event, arm = IPD.Brahmer.a$arm, tau = 25)

plot(
result.rmst2,
xlab = "Months",
ylab = "Probability",
col = "black",
col.RMST = "#E7B800", 
col.RMTL = "#2E9FDF",
density = 80,
angle = 85
)
```

<br>
<br>

\clearpage 

## Mok et al. 2009 IPASS Study: Dimishing Treatment Effect

```{r, echo = FALSE, fig.cap="Patients with unknown EGFR mutation status", warning=FALSE, message=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

km_trt_fit <- survfit(Surv(time, event) ~ arm, data = IPD.Mok.C)

ggsurv <- ggsurvplot(
  km_trt_fit,                     # survfit object with calculated statistics.
  data = IPD.Mok.C,             # data used to fit survival curves.
  risk.table = TRUE,       # show risk table.
  pval = FALSE,             # show p-value of log-rank test.
  conf.int = FALSE,         # show confidence intervals for 
  # point estimates of survival curves.
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0,12),         # present narrower X axis, but not affect
  # survival estimates.
  xlab = "Months since Randomization",   # customize X axis label.
  ylab = "Pr of Progression-free Survival",   # customize X axis label.
  break.time.by = 4,     # break X axis in time intervals by 500.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.height = 0.25, # the height of the risk table
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  ncensor.plot.height = 0.25,
  conf.int.style = "step",  # customize style of confidence intervals
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = c("Carboplatin", "Gefitinib")    # change legend labels.
)

# Labels for Survival Curves (plot)
ggsurv$plot <- ggsurv$plot + labs(
  title    = "Kaplan-Meier Curves for Progression-free Survival",                  
  subtitle = "Patients with unknown EGFR mutation status"
)

# Changing the font size, style and color

ggsurv <- ggpar(
  ggsurv,
  font.title    = c(16, "bold", "black"),         
  font.subtitle = c(10, "bold.italic", "black"), 
  font.caption  = c(14, "plain", "black"),        
  font.x        = c(14, "bold.italic", "black"),          
  font.y        = c(14, "bold.italic", "black"),      
  font.xtickslab = c(12, "plain", "black"),
  legend = "top"
)

ggsurv
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Summary Statistics", warning=FALSE, message=FALSE, eval=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

IPD.Mok.C <- IPD.Mok.C[,2:3]

colnames(IPD.Mok.C) <- c("event", "Gefitinib")

IPD.Mok.C$Gefitinib <- ifelse(IPD.Mok.C$Gefitinib == 0, "Carboplatin", "Gefitinib")

IPD.Mok.C %>%
  tbl_summary(
    by = Gefitinib,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  modify_header(stat_by = md("**{level}**<br>N =  {n} ({style_percent(p)}%)")) %>%
  bold_labels() %>%
  modify_spanning_header(starts_with("stat_") ~ "**Summary Statistics**") %>% 
  add_p(test = all_continuous() ~ "t.test") %>%
  add_overall()
```

<br>
<br>

```{r, echo=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

colnames(IPD.Mok.C) <- c("time", "event", "Gefitinib")

cox.model <- coxph(Surv(time, event) ~ Gefitinib, data = IPD.Mok.C) 

# Schoenfeld plot
par(mfrow=c(1,1))
plot(cox.zph(cox.model), main = "Schoenfeld Individual Test p: 0.00")
abline(h=0, col=2)
```

<br>
<br>

```{r echo=FALSE, fig.cap="Cox Proportional Hazards Model"}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

colnames(IPD.Mok.C) <- c("time", "event", "arm")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ arm, data = IPD.Mok.C) 

# format results into data frame with global p-values
cox.model %>%
  tbl_regression(
    show_single_row = arm,
    label = arm ~ "Gefitinib vs Carboplatin-Paclitaxel",
    exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

----------------------------------------------------------------------------------
  Average HR                           95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  3.863                              2.699   5.531                   0.000   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher) Weighted Cox Proportional Hazards Model

At a given instant in time a patient recieving the Nivolumab treatment is 3.863 times as likely to die as a patient who is on the Docetaxel treatment. The 95% confidence interval was (2.699, 5.531) with p value 0.00 .

<br>
<br>

----------------------------------------------------------------------------------
  $\hat{c}^{\prime} \%$                95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  79.44%                             72.96, 84.69                   0.000    
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher1) Weighted Cox Proportional Hazards Model (Generalized Concordance)

With a probability of 79.44% (95% CI:72.96%, 84.69%), a patient treated with Gefitinib expected (at the baseline value) to die earlier than a patient treated with Carboplatin-Paclitaxel with p value 0.000.

<br>
<br>

```{r, echo=FALSE, fig.cap="Weights used by weighted Cox regression are plotted against time"}
knitr::include_graphics(path = "figure/mok.c.coxph.svg")
```
In this study the increase in the censoring weights are large during the course of the treatment. However, it should be noted that the normalised total weight range is [0, 2]. 

<br>
<br>

```{r, echo=FALSE, fig.cap="Weighted Log Rank Test"}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

IPD.Mok.C$event <- ifelse(IPD.Mok.C$event == 0, 1, 0)

IPD.Mok.C$arm <- ifelse(IPD.Mok.C$arm == 1, "control", "experimental")

colnames(IPD.Mok.C) <- c("time", "event", "arm")

result <- wlr.Stat(surv=IPD.Mok.C$time, cnsr=IPD.Mok.C$event, trt= IPD.Mok.C$arm, fparam=list(rho=c(0,0,1,1), gamma=c(0,1,1,0), wlr='FH(0,1)', APPLE=NULL))

result %>% 
  kableExtra::kable()
```

<br>
<br>

```{r, echo=FALSE, include=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

rgs <- list(c(0, 0), c(0, 1), c(1, 1), c(1, 0))

draws <- 10

IPD.Mok.C$event <- ifelse(IPD.Mok.C$event == 0, 1, 0)

IPD.Mok.C$arm <- ifelse(IPD.Mok.C$arm == 1, "control", "experimental")

result.mc <- nphsim::combo.wlr(survival = IPD.Mok.C$time, cnsr = IPD.Mok.C$event, trt = IPD.Mok.C$arm, fparam = list(rgs=rgs,draws=draws))

result.mc <- lapply(result.mc, function(x) round(x, digits = 3))
```

```{r, echo=FALSE}
as.data.frame(result.mc) %>% kableExtra::kable()
```

<br>
<br>
  
```{r, include=FALSE, message=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

IPD.Mok.C$arm <- ifelse(IPD.Mok.C$arm == 0, "control", "experimental")

IPD.Mok.C$event <- ifelse(IPD.Mok.C$event == 0, 1, 0)

result.rmst <- rmst.Stat(survival = IPD.Mok.C$time, cnsr = IPD.Mok.C$event, trt = IPD.Mok.C$arm, stra = NULL, fparam = 12)

result.rmst_ <- lapply(result.rmst, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.rmst_) %>% kableExtra::kable()
```

```{r, include=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

result.rmst2 = rmst2(time = IPD.Mok.C$time, status = IPD.Mok.C$event, arm = IPD.Mok.C$arm, tau = 12)

result.rmst2
```

The point estimate indicated that patients on the Gefitinib treatment survive `r round(result.rmst2$unadjusted.result[1,1],1)` months longer than those on Carboplatin-Paclitaxel group on average, when following up the patients `r result.rmst2$tau` months. The 95% confidence interval was (`r round(result.rmst2$unadjusted.result[1,2],1)` to `r round(result.rmst2$unadjusted.result[1,3],1)`) with p value `r round(result.rmst2$unadjusted.result[1,4],1)`.

```{r, echo=FALSE}
source("Libraries.R")

IPD.Mok.C <- readRDS("data/IPD.Mok.C.RDS")

result.rmst2 = rmst2(time = IPD.Mok.C$time, status = IPD.Mok.C$event, arm = IPD.Mok.C$arm, tau = 12)

plot(
result.rmst2,
xlab = "Months",
ylab = "Probability",
col = "black",
col.RMST = "#E7B800", 
col.RMTL = "#2E9FDF",
density = 80,
angle = 85
)
```

<br>
<br>

\clearpage 

## Ohtsu et al. 2011 AVAGAST Study: Dimishing Treatment Effect

```{r, echo=FALSE, fig.cap="Patients in the intention-to-treat population", warning=FALSE, message=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

km_trt_fit <- survfit(Surv(time, event) ~ arm, data = IPD.Ohtsu)

ggsurv <- ggsurvplot(
  km_trt_fit,               # survfit object with calculated statistics.
  data = IPD.Ohtsu,         # data used to fit survival curves.
  risk.table = TRUE,        # show risk table.
  pval = FALSE,             # show p-value of log-rank test.
  conf.int = FALSE,         # show confidence intervals for 
  # point estimates of survival curves.
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0,21),         # present narrower X axis, but not affect
  # survival estimates.
  xlab = "Months since Randomization",   # customize X axis label.
  ylab = "Survival (probability)",   # customize X axis label.
  break.time.by = 3,     # break X axis in time intervals by 500.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.height = 0.25, # the height of the risk table
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  ncensor.plot.height = 0.25,
  conf.int.style = "step",  # customize style of confidence intervals
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = c("Placebo", "Bevacizumab")    # change legend labels.
)

# Labels for Survival Curves (plot)
ggsurv$plot <- ggsurv$plot + labs(
  title    = "Kaplan-Meier estimates of overall survival",                  
  subtitle = "Patients in the intention-to-treat population"
)

# Changing the font size, style and color

ggsurv <- ggpar(
  ggsurv,
  font.title    = c(16, "bold", "black"),         
  font.subtitle = c(10, "bold.italic", "black"), 
  font.caption  = c(14, "plain", "black"),        
  font.x        = c(14, "bold.italic", "black"),          
  font.y        = c(14, "bold.italic", "black"),      
  font.xtickslab = c(12, "plain", "black"),
  legend = "top"
)

ggsurv
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Summary Statistics", warning=FALSE, message=FALSE, eval=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

IPD.Ohtsu <- IPD.Ohtsu[, 2:3]

colnames(IPD.Ohtsu) <- c("event", "Bevacizumab")

IPD.Ohtsu$Bevacizumab <- ifelse(IPD.Ohtsu$Bevacizumab, "Placebo", "Bevacizumab")

IPD.Ohtsu %>%
  tbl_summary(
    by = Bevacizumab,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  modify_header(stat_by = md("**{level}**<br>N =  {n} ({style_percent(p)}%)")) %>%
  bold_labels() %>%
  modify_spanning_header(starts_with("stat_") ~ "**Summary Statistics**") %>% 
  add_p(test = all_continuous() ~ "t.test") %>%
  add_overall()
```

<br>
<br>

```{r, echo=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

colnames(IPD.Ohtsu) <- c("time", "event", "Bevacizumab")

cox.model <- coxph(Surv(time, event) ~ Bevacizumab, data = IPD.Ohtsu) 

# Schoenfeld plot
par(mfrow=c(1,1))
plot(cox.zph(cox.model), main = "Schoenfeld Individual Test p: 0.0139")
abline(h=0, col=2)
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Cox Proportional Hazards Model"}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

colnames(IPD.Ohtsu) <- c("time", "event", "arm")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ arm, data = IPD.Ohtsu) 

# format results into data frame with global p-values
cox.model %>%
  tbl_regression(
    show_single_row = arm,
    label = arm ~ "Bevacizumab vs Placebo",
    exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

----------------------------------------------------------------------------------
  Average HR                           95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  0.852                              0.716, 1.015                   0.073  
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher) Weighted Cox Proportional Hazards Model

At a given instant in time a patient recieving the Nivolumab treatment is 0.852 times as likely to die as a patient who is on the Docetaxel treatment. The 95% confidence interval was (0.716, 1.015) with p value 0.073.

<br>
<br>

----------------------------------------------------------------------------------
  $\hat{c}^{\prime} \%$                95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  46.01%                            41.71, 50.37                   0.073   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher1) Weighted Cox Proportional Hazards Model (Generalized Concordance)

With a probability of 46.01% (95% CI:41.71%, 50.37%), a patient treated with Gefitinib expected (at the baseline value) to die earlier than a patient treated with Carboplatin-Paclitaxel with p value 0.073.

<br>
<br>

```{r, echo=FALSE, fig.cap="Weights used by weighted Cox regression are plotted against time"}
knitr::include_graphics(path = "figure/ohtsu.coxphw.svg")
```
In this study the increase in the censoring weights are small during the first 12 months of treatment, after this they begin to rise rapidly. However, it should be noted that the normalised total weight range is [1,25, 2]. 

<br>
<br>

```{r, echo=FALSE, fig.cap="Weighted Log Rank Test"}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

IPD.Ohtsu$event <- ifelse(IPD.Ohtsu$event == 0, 1, 0)

colnames(IPD.Ohtsu) <- c("time", "event", "arm")

result <- wlr.Stat(surv=IPD.Ohtsu$time, cnsr=IPD.Ohtsu$event, trt= IPD.Ohtsu$arm, fparam=list(rho=c(0,0,1,1), gamma=c(0,1,1,0), wlr='FH(0,1)', APPLE=NULL))

result %>% 
  kableExtra::kable()
```

<br>
<br>

```{r, echo=FALSE, include=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

IPD.Ohtsu$event <- ifelse(IPD.Ohtsu$event == 0, 1, 0)

IPD.Ohtsu$arm <- ifelse(IPD.Ohtsu$arm == 0, "control", "experimental")

rgs <- list(c(0, 0), c(0, 1), c(1, 0), c(1, 1))

draws <- 10

result.mc <- nphsim::combo.wlr(survival = IPD.Ohtsu$time, cnsr = IPD.Ohtsu$event, trt = IPD.Ohtsu$arm, fparam = list(rgs=rgs,draws=draws))

result.mc <- lapply(result.mc, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.mc) %>% kableExtra::kable()
```

<br>
<br>
  
```{r, include=FALSE, message=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

IPD.Ohtsu$arm <- ifelse(IPD.Ohtsu$arm == 0, "control", "experimental")

IPD.Ohtsu$event <- ifelse(IPD.Ohtsu$event == 0, 1, 0)

result.rmst <- rmst.Stat(survival = IPD.Ohtsu$time, cnsr = IPD.Ohtsu$event, trt = IPD.Ohtsu$arm, stra = NULL, fparam = 22)

result.rmst_ <- lapply(result.rmst, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.rmst_) %>% kableExtra::kable()
```

```{r, include=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

result.rmst2 = rmst2(time = IPD.Ohtsu$time, status = IPD.Ohtsu$event, arm = IPD.Ohtsu$arm, tau = 22)

result.rmst2
```

The point estimate indicated that patients on the Gefitinib treatment survive `r round(result.rmst2$unadjusted.result[1,1],1)` months longer than those on Carboplatin-Paclitaxel group on average, when following up the patients `r result.rmst2$tau` months. The 95% confidence interval was (`r round(result.rmst2$unadjusted.result[1,2],1)` to `r round(result.rmst2$unadjusted.result[1,3],1)`) with p value `r round(result.rmst2$unadjusted.result[1,4],1)`.

```{r, echo=FALSE}
source("Libraries.R")

IPD.Ohtsu <- readRDS("data/IPD.Ohtsu.RDS")

result.rmst2 = rmst2(time = IPD.Ohtsu$time, status = IPD.Ohtsu$event, arm = IPD.Ohtsu$arm, tau = 22)

plot(
result.rmst2,
xlab = "Months",
ylab = "Probability",
col = "black",
col.RMST = "#E7B800", 
col.RMTL = "#2E9FDF",
density = 80,
angle = 85
)
```

<br>
<br>

\clearpage 

## Ascierto et al. 2017 The Ipilimumab Study: Delayed Treatment Effect

```{r, echo=FALSE, fig.cap="Patients in the intention-to-treat population", warning=FALSE, message=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

km_trt_fit <- survfit(Surv(time, event) ~ arm, data = IPD.ascierto.2.a)

ggsurv <- ggsurvplot(
  km_trt_fit,               # survfit object with calculated statistics.
  data = IPD.ascierto.2.a,  # data used to fit survival curves.
  risk.table = TRUE,        # show risk table.
  pval = FALSE,             # show p-value of log-rank test.
  conf.int = FALSE,         # show confidence intervals for 
  # point estimates of survival curves.
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0,45),         # present narrower X axis, but not affect
  # survival estimates.
  xlab = "Time since randomisation (months)",   # customize X axis label.
  ylab = "Overall survival (%)",   # customize X axis label.
  break.time.by = 3,     # break X axis in time intervals by 500.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.height = 0.25, # the height of the risk table
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  ncensor.plot.height = 0.25,
  conf.int.style = "step",  # customize style of confidence intervals
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = c("3mg", "10mg")    # change legend labels.
)

# Labels for Survival Curves (plot)
ggsurv$plot <- ggsurv$plot + labs(
  title    = "Kaplan-Meier Curves for Over-all Survival",                  
  subtitle = "Overall survival in the intention-to-treat population."
)

# Changing the font size, style and color

ggsurv <- ggpar(
  ggsurv,
  font.title    = c(16, "bold", "black"),         
  font.subtitle = c(10, "bold.italic", "black"), 
  font.caption  = c(14, "plain", "black"),        
  font.x        = c(14, "bold.italic", "black"),          
  font.y        = c(14, "bold.italic", "black"),      
  font.xtickslab = c(12, "plain", "black"),
  legend = "top"
)

ggsurv
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Summary Statistics", warning=FALSE, message=FALSE, eval=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

IPD.ascierto.2.a <- IPD.ascierto.2.a[, 2:3]

# rename columns 
colnames(IPD.ascierto.2.a) <- c("event", "10mg")

IPD.ascierto.2.a$`10mg` <- ifelse(IPD.ascierto.2.a$`10mg` == 0, "Ipilimumab 3 mg/kg", "Ipilimumab 10 mg/kg")

IPD.ascierto.2.a %>%
  tbl_summary(
    by = `10mg`,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  modify_header(stat_by = md("**{level}**<br>N =  {n} ({style_percent(p)}%)")) %>%
  bold_labels() %>%
  modify_spanning_header(starts_with("stat_") ~ "**Summary statistics**") %>% 
  add_p(test = all_continuous() ~ "t.test") %>%
  add_overall()
```

<br>
<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

colnames(IPD.ascierto.2.a) <- c("time", "event", "10mg")

cox.model <- coxph(Surv(time, event) ~ IPD.ascierto.2.a$`10mg`, data = IPD.ascierto.2.a) 

# Schoenfeld plot
par(mfrow=c(1,1))
plot(cox.zph(cox.model), main = "Schoenfeld Individual Test p: 0.1812")
abline(h=0, col=2)
```

<br>
<br>

```{r echo=FALSE, fig.cap="Cox Proportional Hazards Model"}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

colnames(IPD.ascierto.2.a) <- c("time", "event", "arm")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ arm, data = IPD.ascierto.2.a) 

# format results into data frame with global p-values
cox.model %>%
  tbl_regression(
    show_single_row = arm,
    label = arm ~ "10mg vs 3mg",
    exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

----------------------------------------------------------------------------------
  Average HR                           95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  0.884                              0.739, 1.058                   0.179   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher) Weighted Cox Proportional Hazards Model

At a given instant in time a patient recieving the Nivolumab treatment is 0.846 times as likely to die as a patient who is on the Docetaxel treatment. The 95% confidence interval was (0.691, 1.0348) with p value 0.179.

<br>
<br>

----------------------------------------------------------------------------------
  $\hat{c}^{\prime} \%$                95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  46.93%                             42.5, 51.41                   0.179   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher1) Weighted Cox Proportional Hazards Model (Generalized Concordance)

With a probability of 46.93% (95% CI:42.5%, 51.41%), a patient treated with Gefitinib expected (at the baseline value) to die earlier than a patient treated with Carboplatin-Paclitaxel with p value 0.179.

<br>
<br>

```{r, echo=FALSE, fig.cap="Weights used by weighted Cox regression are plotted against time"}
knitr::include_graphics(path = "figure/asc.coxphw.svg")
```
In this study the increase in the censoring weights are large during the first 3 months of treatment, after this they begin to rise slowly until after 40 months and then increase very quickly. However, it should be noted that the normalised total weight range is [0.5, 1.75]. 

<br>
<br>

```{r, echo=FALSE, fig.cap="Weighted Log Rank Test"}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

IPD.ascierto.2.a$event <- ifelse(IPD.ascierto.2.a$event == 0, 1, 0)

colnames(IPD.ascierto.2.a) <- c("time", "event", "arm")

result <- wlr.Stat(surv=IPD.ascierto.2.a$time, cnsr=IPD.ascierto.2.a$event, trt= IPD.ascierto.2.a$arm, fparam=list(rho=c(0,0,1,1), gamma=c(0,1,1,0), wlr='FH(0,1)', APPLE=NULL))

result %>% 
  kableExtra::kable()
```

<br>
<br>

```{r, echo=FALSE, include=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

rgs <- list(c(0, 0), c(0, 1), c(1, 1), c(1, 0))

draws <- 10

IPD.ascierto.2.a$event <- ifelse(IPD.ascierto.2.a$event == 0, 1, 0)

IPD.ascierto.2.a$arm <- ifelse(IPD.ascierto.2.a$arm == 0, "control", "experimental")

result.mc <- nphsim::combo.wlr(survival = IPD.ascierto.2.a$time, cnsr = IPD.ascierto.2.a$event, trt = IPD.ascierto.2.a$arm, fparam = list(rgs=rgs,draws=draws))

result.mc <- lapply(result.mc, function(x) round(x, digits = 3))
```

```{r, echo=FALSE}
as.data.frame(result.mc) %>% kableExtra::kable()
```

<br>
<br>
  
```{r, include=FALSE, message=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

IPD.ascierto.2.a$arm <- ifelse(IPD.ascierto.2.a$arm == 0, "control", "experimental")

IPD.ascierto.2.a$event <- ifelse(IPD.ascierto.2.a$event == 0, 1, 0)

result.rmst <- rmst.Stat(survival = IPD.ascierto.2.a$time, cnsr = IPD.ascierto.2.a$event, trt = IPD.ascierto.2.a$arm, stra = NULL, fparam = 45)

result.rmst_ <- lapply(result.rmst, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.rmst_) %>% kableExtra::kable()
```

```{r, include=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

result.rmst2 = rmst2(time = IPD.ascierto.2.a$time, status = IPD.ascierto.2.a$event, arm = IPD.ascierto.2.a$arm, tau = 45)

result.rmst2
```

The point estimate indicated that patients on the Ipilimumab 10 mg/kg treatment survive `r round(result.rmst2$unadjusted.result[1,1],1)` months longer than those on Ipilimumab 3 mg/kg group on average, when following up the patients `r result.rmst2$tau` months. The 95% confidence interval was (`r round(result.rmst2$unadjusted.result[1,2],1)` to `r round(result.rmst2$unadjusted.result[1,3],1)`) with p value `r round(result.rmst2$unadjusted.result[1,4],1)`.

```{r, echo=FALSE}
source("Libraries.R")

IPD.ascierto.2.a <- readRDS("data/IPD.ascierto.2.a.RDS")

result.rmst2 = rmst2(time = IPD.ascierto.2.a$time, status = IPD.ascierto.2.a$event, arm = IPD.ascierto.2.a$arm, tau = 45)

plot(
result.rmst2,
xlab = "Months",
ylab = "Probability",
col = "black",
col.RMST = "#E7B800", 
col.RMTL = "#2E9FDF",
density = 80,
angle = 85
)
```

<br>
<br>

\clearpage 

## Rittermeyer et al. 2017 The OAK Study: Delayed Treatment Effect

```{r, echo = FALSE, fig.cap="Patients in the WT population", warning=FALSE, message=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

km_trt_fit <- survfit(Surv(time, event) ~ arm, data = IPD.Rittmeyer)

ggsurv <- ggsurvplot(
  km_trt_fit,               # survfit object with calculated statistics.
  data = IPD.Rittmeyer,     # data used to fit survival curves.
  risk.table = TRUE,        # show risk table.
  pval = FALSE,             # show p-value of log-rank test.
  conf.int = FALSE,         # show confidence intervals for 
  # point estimates of survival curves.
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0,26),         # present narrower X axis, but not affect
  # survival estimates.
  xlab = "Months since Randomization",   # customize X axis label.
  ylab = "Pr of Progression-free Survival",   # customize X axis label.
  break.time.by = 2,     # break X axis in time intervals by 500.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.height = 0.25, # the height of the risk table
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  ncensor.plot.height = 0.25,
  conf.int.style = "step",  # customize style of confidence intervals
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = c("Docetaxel","Atezolizumab")    # change legend labels.
)

# Labels for Survival Curves (plot)
ggsurv$plot <- ggsurv$plot + labs(
  title    = "Kaplan Meier Estimates of Progression-free Survival",                  
  subtitle = "Patients in the IIT population"
)

# Changing the font size, style and color

ggsurv <- ggpar(
  ggsurv,
  font.title    = c(16, "bold", "black"),         
  font.subtitle = c(10, "bold.italic", "black"), 
  font.caption  = c(14, "plain", "black"),        
  font.x        = c(14, "bold.italic", "black"),          
  font.y        = c(14, "bold.italic", "black"),      
  font.xtickslab = c(12, "plain", "black"),
  legend = "top"
)

ggsurv
```

<br>
<br>

```{r, echo=FALSE, fig.cap="Summary Statistics", warning=FALSE, message=FALSE, eval=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

IPD.Rittmeyer <- IPD.Rittmeyer[, 2:3]

# rename columns 
colnames(IPD.Rittmeyer) <- c("event", "Atezolizumab")

IPD.Rittmeyer$Atezolizumab <- ifelse(IPD.Rittmeyer$Atezolizumab == 0, "Docetaxel", "Atezolizumab")

IPD.Rittmeyer %>%
  tbl_summary(
    by = Atezolizumab,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
  ) %>%
  modify_header(stat_by = md("**{level}**<br>N =  {n} ({style_percent(p)}%)")) %>%
  bold_labels() %>%
  modify_spanning_header(starts_with("stat_") ~ "**Summary Statistics**") %>% 
  add_p(test = all_continuous() ~ "t.test") %>%
  add_overall()
```

<br>
<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

colnames(IPD.Rittmeyer) <- c("time", "event", "Atezolizumab")

cox.model <- coxph(Surv(time, event) ~ IPD.Rittmeyer$`Atezolizumab`, data = IPD.Rittmeyer) 

# Schoenfeld plot
par(mfrow=c(1,1))
plot(cox.zph(cox.model), main = "Schoenfeld Individual Test p: 0.3971")
abline(h=0, col=2)
```

<br>
<br>

```{r echo=FALSE, fig.cap="Cox Proportional Hazards Model"}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

colnames(IPD.Rittmeyer) <- c("time", "event", "arm")

# fit coxph model
cox.model <- coxph(Surv(time, event) ~ arm, data = IPD.Rittmeyer) 

# format results into data frame with global p-values
cox.model %>%
  tbl_regression(
    show_single_row = arm,
    label = arm ~ "Atezolizumab versus Docetaxel",
    exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

----------------------------------------------------------------------------------
  Average HR                           95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  0.728                              0.614, 0.863                   0.000   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher) Weighted Cox Proportional Hazards Model

At a given instant in time a patient recieving the Atezolizumab treatment is 0.0.728 times as likely to die as a patient who is on the Docetaxel treatment. The 95% confidence interval was (0.614, 0.863) with p value 0.000.

<br>
<br>

----------------------------------------------------------------------------------
  $\hat{c}^{\prime} \%$                95% CI	                      p-value
------------------------- ---------------------------------- ---------------------
  42.13%                            38.05, 46.31                     0.000   
------------------------- ---------------------------------- ---------------------
Table: (\#tab:inher1) Weighted Cox Proportional Hazards Model (Generalized Concordance)

With a probability of 49.12% (95% CI:45.8%, 52.5%), a patient treated with Gefitinib expected (at the baseline value) to die earlier than a patient treated with Carboplatin-Paclitaxel with p value 0.000.

<br>
<br>

```{r, echo=FALSE, fig.cap="Weights used by weighted Cox regression are plotted against time"}
knitr::include_graphics(path = "figure/ritt.coxphw.svg")
```
In this study the increase in the censoring weights are small during the first 18 months of treatment, after this they begin to rise rapidly. However, it should be noted that the normalised total weight range is [1.5, 2]. 

<br>
<br>

```{r, echo=FALSE, fig.cap="Weighted Log Rank Test"}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

IPD.Rittmeyer$event <- ifelse(IPD.Rittmeyer$event == 0, 1, 0)

colnames(IPD.Rittmeyer) <- c("time", "event", "arm")

result <- wlr.Stat(surv=IPD.Rittmeyer$time, cnsr=IPD.Rittmeyer$event, trt= IPD.Rittmeyer$arm, fparam=list(rho=c(0,0,1,1), gamma=c(0,1,1,0), wlr='FH(0,1)', APPLE=NULL))

result %>% 
  kableExtra::kable()
```

<br>
<br>

```{r, echo=FALSE, include=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

IPD.Rittmeyer$event <- ifelse(IPD.Rittmeyer$event == 0, 1, 0)

IPD.Rittmeyer$arm <- ifelse(IPD.Rittmeyer$arm == 0, "control", "experimental")

rgs <- list(c(0, 0), c(0, 1), c(1, 1), c(1, 0))

draws <- 10

result.mc <- nphsim::combo.wlr(survival = IPD.Rittmeyer$time, cnsr = IPD.Rittmeyer$event, trt = IPD.Rittmeyer$arm, fparam = list(rgs=rgs,draws=draws))

result.mc <- lapply(result.mc, function(x) round(x, digits = 3))
```

```{r, echo=FALSE}
as.data.frame(result.mc) %>% kableExtra::kable()
```

<br>
<br>
  
```{r, include=FALSE, message=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

IPD.Rittmeyer$arm <- ifelse(IPD.Rittmeyer$arm == 0, "control", "experimental")

IPD.Rittmeyer$event <- ifelse(IPD.Rittmeyer$event == 0, 1, 0)

result.rmst <- rmst.Stat(survival = IPD.Rittmeyer$time, cnsr = IPD.Rittmeyer$event, trt = IPD.Rittmeyer$arm, stra = NULL, fparam = 26)

result.rmst_ <- lapply(result.rmst, function(x) round(x, digits = 5))
```

```{r, echo=FALSE}
as.data.frame(result.rmst_) %>% kableExtra::kable()
```

```{r, include=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

result.rmst2 = rmst2(time = IPD.Rittmeyer$time, status = IPD.Rittmeyer$event, arm = IPD.Rittmeyer$arm, tau = 26)

result.rmst2
```

The point estimate indicated that patients on the Atezolizumab treatment survive `r round(result.rmst2$unadjusted.result[1,1],1)` months longer than those on Docetaxel group on average, when following up the patients `r result.rmst2$tau` months. The 95% confidence interval was (`r round(result.rmst2$unadjusted.result[1,2],1)` to `r round(result.rmst2$unadjusted.result[1,3],1)`) with p value `r round(result.rmst2$unadjusted.result[1,4],1)`.

```{r, echo=FALSE}
source("Libraries.R")

IPD.Rittmeyer <- readRDS("data/IPD.Rittmeyer.RDS")

result.rmst2 = rmst2(time = IPD.Rittmeyer$time, status = IPD.Rittmeyer$event, arm = IPD.Rittmeyer$arm, tau = 26)

plot(
result.rmst2,
xlab = "Months",
ylab = "Probability",
col = "black",
col.RMST = "#E7B800", 
col.RMTL = "#2E9FDF",
density = 80,
angle = 85
)
```

<br>
<br>

## Math

\TeX\ is the best way to typeset mathematics. Donald Knuth designed \TeX\ when he got frustrated at how long it was taking the typesetters to finish his book, which contained a lot of mathematics.  One nice feature of _R Markdown_ is its ability to read LaTeX code directly.

If you are doing a thesis that will involve lots of math, you will want to read the following section which has been commented out. If you're not going to use math, skip over or delete this next commented section.


<!-- MATH and PHYSICS majors: Uncomment the following section -->
<!--
$$\sum_{j=1}^n (\delta\theta_j)^2 \leq {{\beta_i^2}\over{\delta_i^2 + \rho_i^2}}
\left[ 2\rho_i^2 + {\delta_i^2\beta_i^2\over{\delta_i^2 + \rho_i^2}} \right] \equiv \omega_i^2
$$

From Informational Dynamics, we have the following (Dave Braden):

After _n_ such encounters the posterior density for $\theta$ is

$$
\pi(\theta|X_1< y_1,\dots,X_n<y_n) \varpropto \pi(\theta) \prod_{i=1}^n\int_{-\infty}^{y_i}
   \exp\left(-{(x-\theta)^2\over{2\sigma^2}}\right)\ dx
$$

Another equation:

$$\det\left|\,\begin{matrix}%
c_0&c_1\hfill&c_2\hfill&\ldots&c_n\hfill\cr
c_1&c_2\hfill&c_3\hfill&\ldots&c_{n+1}\hfill\cr
c_2&c_3\hfill&c_4\hfill&\ldots&c_{n+2}\hfill\cr
\,\vdots\hfill&\,\vdots\hfill&
  \,\vdots\hfill&&\,\vdots\hfill\cr
c_n&c_{n+1}\hfill&c_{n+2}\hfill&\ldots&c_{2n}\hfill\cr
\end{matrix}\right|>0$$


Lapidus and Pindar, Numerical Solution of Partial Differential Equations in Science and
Engineering.  Page 54

$$
\int_t\left\{\sum_{j=1}^3 T_j \left({d\phi_j\over dt}+k\phi_j\right)-kT_e\right\}w_i(t)\ dt=0,
   \qquad\quad i=1,2,3.
$$

L\&P  Galerkin method weighting functions.  Page 55

$$
\sum_{j=1}^3 T_j\int_0^1\left\{{d\phi_j\over dt} + k\phi_j\right\} \phi_i\ dt
   = \int_{0}^1k\,T_e\phi_idt, \qquad i=1,2,3 $$

Another L\&P (p145)

$$
\int_{-1}^1\!\int_{-1}^1\!\int_{-1}^1 f\big(\xi,\eta,\zeta\big)
   = \sum_{k=1}^n\sum_{j=1}^n\sum_{i=1}^n w_i w_j w_k f\big( \xi,\eta,\zeta\big).
$$

Another L\&P (p126)

$$
\int_{A_e} (\,\cdot\,) dx dy = \int_{-1}^1\!\int_{-1}^1 (\,\cdot\,) \det[J] d\xi d\eta.
$$
-->

## Chemistry 101: Symbols

Chemical formulas will look best if they are not italicized. Get around math mode's automatic italicizing in LaTeX by using the argument `$\mathrm{formula here}$`, with your formula inside the curly brackets.  (Notice the use of the backticks here which enclose text that acts as code.)

So, $\mathrm{Fe_2^{2+}Cr_2O_4}$ is written `$\mathrm{Fe_2^{2+}Cr_2O_4}$`.

<!--
The \noindent command below does what you'd expect:  it forces the current line/paragraph to not indent. This was done here to match the format of the LaTeX thesis PDF.
-->

\noindent Exponent or Superscript: $\mathrm{O^-}$

\noindent Subscript: $\mathrm{CH_4}$

To stack numbers or letters as in $\mathrm{Fe_2^{2+}}$, the subscript is defined first, and then the superscript is defined.

\noindent Bullet: CuCl $\bullet$ $\mathrm{7H_{2}O}$


\noindent Delta: $\Delta$

\noindent Reaction Arrows: $\longrightarrow$ or  $\xrightarrow{solution}$

\noindent Resonance Arrows: $\leftrightarrow$

\noindent Reversible Reaction Arrows: $\rightleftharpoons$

### Typesetting reactions

You may wish to put your reaction in an equation environment, which means that LaTeX will place the reaction where it fits and will number the equations for you. 

\begin{equation}
  \mathrm{C_6H_{12}O_6  + 6O_2} \longrightarrow \mathrm{6CO_2 + 6H_2O}
  (\#eq:reaction)
\end{equation}

We can reference this combustion of glucose reaction via Equation \@ref(eq:reaction).

### Other examples of reactions

$\mathrm{NH_4Cl_{(s)}}$ $\rightleftharpoons$ $\mathrm{NH_{3(g)}+HCl_{(g)}}$

\noindent $\mathrm{MeCH_2Br + Mg}$ $\xrightarrow[below]{above}$ $\mathrm{MeCH_2\bullet Mg \bullet Br}$

## Physics

Many of the symbols you will need can be found on the math page <https://web.reed.edu/cis/help/latex/math.html> and the Comprehensive LaTeX Symbol Guide (<https://mirror.utexas.edu/ctan/info/symbols/comprehensive/symbols-letter.pdf>).

## Biology

You will probably find the resources at <https://www.lecb.ncifcrf.gov/~toms/latex.html> helpful, particularly the links to bsts for various journals. You may also be interested in TeXShade for nucleotide typesetting (<https://homepages.uni-tuebingen.de/beitz/txe.html>).  Be sure to read the proceeding chapter on graphics and tables.

